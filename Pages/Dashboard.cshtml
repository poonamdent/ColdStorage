@page
@model ColdStorage.Pages.DashboardModel
@{
    ViewData["Title"] = "Cold Storage Dashboard";
}

<div class="container-fluid mt-4">
    <h2 class="mb-4">
       Cold Storage Dashboard
    </h2>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h6 class="card-title">Total Centres</h6>
                    <h3>@Model.StorageData.Select(s => s.SurveyId).Distinct().Count()</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h6 class="card-title">Total Capacity</h6>
                    <h3>@Model.StorageData.Sum(s => s.ActualCapacity).ToString("N0") MT</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h6 class="card-title">Total Area</h6>
                    <h3>@Model.StorageData.Sum(s => s.TotalArea).ToString("N0") sq.mt</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-funnel"></i> Filters
            </h5>
        </div>
        <div class="card-body">
            <form method="get" id="filterForm">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="state" class="form-label">
                            <i class="bi bi-geo-alt"></i> State
                        </label>
                        <select name="State" id="state" class="form-select" asp-for="State">
                            <option value="">All States</option>
                            @foreach (var state in Model.States)
                            {
                                <option value="@state">@state</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="city" class="form-label">
                            <i class="bi bi-building"></i> City
                        </label>
                        <select name="City" id="city" class="form-select" asp-for="City">
                            <option value="">All Cities</option>
                            @foreach (var city in Model.Cities)
                            {
                                <option value="@city">@city</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="startDate" class="form-label">
                            <i class="bi bi-calendar"></i> Survey From Date
                        </label>
                        <input type="date" name="StartDate" id="startDate" class="form-control" asp-for="StartDate" />
                    </div>
                    <div class="col-md-4">
                        <label for="endDate" class="form-label">
                            <i class="bi bi-calendar"></i> Survey To Date
                        </label>
                        <input type="date" name="EndDate" id="endDate" class="form-control" asp-for="EndDate" />
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Apply Filters
                        </button>
                        <a href="/Dashboard" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Clear Filters
                        </a>
                        <button type="button" class="btn btn-success" onclick="exportToExcel()">
                            <i class="bi bi-file-earmark-excel"></i> Export to Excel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabs Section -->
    <ul class="nav nav-tabs nav-fill" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tabular-tab" data-bs-toggle="tab" data-bs-target="#tabular" type="button" role="tab">
                <i class="bi bi-table"></i> Tabular View
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab">
                <i class="bi bi-bar-chart-fill"></i> Charts & Diagrams
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="graphs-tab" data-bs-toggle="tab" data-bs-target="#graphs" type="button" role="tab">
                <i class="bi bi-geo-alt-fill"></i> Map & Graphs
            </button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-3" id="dashboardTabContent">
        <!-- Tabular View -->
        <div class="tab-pane fade show active" id="tabular" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Complete Data Summary</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered" id="dataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>State</th>
                                    <th>City</th>
                                    <th>Location</th>
                                    <th>Capacity (MT)</th>
                                    <th>Area (sq.mt)</th>
                                    <th>Survey Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.StorageData.Any())
                                {
                                    @foreach (var item in Model.StorageData)
                                    {
                                        <tr>
                                            <td>@item.Id</td>
                                            <td>@item.State</td>
                                            <td>@item.City</td>
                                            <td>@item.Location</td>
                                            <td class="text-end">@item.ActualCapacity.ToString("N2")</td>
                                            <td class="text-end">@item.TotalArea.ToString("N2")</td>
                                            <td>@item.SurveyDate.ToString("yyyy-MM-dd")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">
                                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                            <p class="mt-2">No data available. Please check your database connection and table structure.</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            @if (Model.StorageData.Any())
                            {
                                <tfoot class="table-secondary">
                                    <tr>
                                        <th class="text-end">@Model.StorageData.Select(s => s.SurveyId).Distinct().Count()</th>
                                        <th colspan="3" class="text-end">Totals:</th>
                                        <th class="text-end">@Model.StorageData.Sum(s => s.ActualCapacity).ToString("N2")</th>
                                        <th class="text-end">@Model.StorageData.Sum(s => s.TotalArea).ToString("N2")</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            }
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts View -->
        <div class="tab-pane fade" id="charts" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body">
                    @if (Model.StorageData.Any())
                    {
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">Capacity by State (MT)</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="capacityChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">Area Distribution by State (sq.mt)</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="areaChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">Capacity by Location (MT)</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="locationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">State-wise Distribution</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="pieChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="mb-0">State-wise Capacity vs Area Analysis</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="regionalChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-bar-chart" style="font-size: 3rem;"></i>
                            <p class="mt-3">No data available to display charts</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Map View -->
        <div class="tab-pane fade" id="graphs" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Storage Locations Map & Geographic Analysis</h5>
                </div>
                <div class="card-body">
                    @if (Model.StorageData.Any())
                    {
                        <div id="map" style="height: 600px; width: 100%;" class="mb-3 border rounded"></div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Legend</h6>
                                <div class="d-flex gap-3 flex-wrap">
                                    <span><i class="bi bi-circle-fill text-success"></i> Active</span>
                                    <span><i class="bi bi-circle-fill text-warning"></i> Maintenance</span>
                                    <span><i class="bi bi-circle-fill text-secondary"></i> Inactive</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Map Statistics</h6>
                                <p class="mb-0">
                                    <strong>Total Markers:</strong> @Model.StorageData.Count |
                                    <strong>States:</strong> @Model.States.Count |
                                    <strong>Active:</strong> @Model.StorageData.Count(s => s.Status == "Active")
                                </p>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-map" style="font-size: 3rem;"></i>
                            <p class="mt-3">No location data available to display on map</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <script>
        var storageData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.StorageData));
        var chartsInitialized = false;
        var mapInitialized = false;

        // Initialize charts when Charts tab is shown
        document.getElementById('charts-tab').addEventListener('shown.bs.tab', function () {
            if (!chartsInitialized && storageData.length > 0) {
                initializeCharts();
                chartsInitialized = true;
            }
        });

        // Initialize map when Map tab is shown
        document.getElementById('graphs-tab').addEventListener('shown.bs.tab', function () {
            if (!mapInitialized && storageData.length > 0) {
                initializeMap();
                mapInitialized = true;
            }
        });

        function initializeCharts() {
            // Group data by State
            var stateData = {};
            storageData.forEach(item => {
                if (!stateData[item.State]) {
                    stateData[item.State] = { capacity: 0, area: 0, count: 0 };
                }
                stateData[item.State].capacity += item.ActualCapacity;
                stateData[item.State].area += item.TotalArea;
                stateData[item.State].count += 1;
            });

            // Capacity by State Chart
            new Chart(document.getElementById('capacityChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(stateData),
                    datasets: [{
                        label: 'Total Capacity (MT)',
                        data: Object.values(stateData).map(d => d.capacity),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Capacity (MT)' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' }
                    }
                }
            });

            // Area by State Chart
            new Chart(document.getElementById('areaChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(stateData),
                    datasets: [{
                        label: 'Total Area (sq.mt)',
                        data: Object.values(stateData).map(d => d.area),
                        backgroundColor: 'rgba(255, 193, 7, 0.6)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Area (sq.mt)' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' }
                    }
                }
            });

            // Capacity by Location Chart
            var locations = storageData.map(item => item.City.length > 15 ? item.City.substring(0, 15) + '...' : item.City);
            var capacities = storageData.map(item => item.ActualCapacity);

            new Chart(document.getElementById('locationChart'), {
                type: 'bar',
                data: {
                    labels: locations,
                    datasets: [{
                        label: 'Capacity (MT)',
                        data: capacities,
                        backgroundColor: 'rgba(23, 162, 184, 0.6)',
                        borderColor: 'rgba(23, 162, 184, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Capacity (MT)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // State Distribution Pie Chart
            new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stateData),
                    datasets: [{
                        label: 'Number of Facilities',
                        data: Object.values(stateData).map(d => d.count),
                        backgroundColor: [
                            'rgba(25, 135, 84, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(23, 162, 184, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'right' }
                    }
                }
            });

            // State-wise Analysis Radar Chart
            new Chart(document.getElementById('regionalChart'), {
                type: 'radar',
                data: {
                    labels: Object.keys(stateData),
                    datasets: [{
                        label: 'Capacity (MT)',
                        data: Object.values(stateData).map(d => d.capacity),
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        pointRadius: 4
                    }, {
                        label: 'Area (sq.mt)',
                        data: Object.values(stateData).map(d => d.area / 100), // Scaled down for better visualization
                        backgroundColor: 'rgba(255, 193, 7, 0.2)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' }
                    }
                }
            });
        }

        var map;
        function initializeMap() {
            if (map) {
                map.remove();
            }

            // Calculate center point
            var validLocations = storageData.filter(item => item.Latitude !== 0 && item.Longitude !== 0);

            var avgLat = validLocations.length > 0
                ? validLocations.reduce((sum, item) => sum + item.Latitude, 0) / validLocations.length
                : 20.5937;
            var avgLon = validLocations.length > 0
                ? validLocations.reduce((sum, item) => sum + item.Longitude, 0) / validLocations.length
                : 78.9629;

            map = L.map('map').setView([avgLat, avgLon], validLocations.length > 0 ? 5 : 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // Add markers for each location
            storageData.forEach(item => {
                if (item.Latitude !== 0 && item.Longitude !== 0) {
                    var color = item.Status === 'Active' ? '#198754' :
                               item.Status === 'Maintenance' ? '#ffc107' : '#6c757d';

                    var marker = L.circleMarker([item.Latitude, item.Longitude], {
                        radius: 10,
                        fillColor: color,
                        color: '#fff',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    var utilization = item.Capacity > 0 ? (item.Used / item.Capacity * 100).toFixed(1) : 0;

                    marker.bindPopup(`
                        <div style="min-width: 200px;">
                            <h6 class="mb-2"><strong>${item.Location}</strong></h6>
                            <table class="table table-sm table-borderless mb-0">
                                <tr><td><strong>State:</strong></td><td>${item.State}</td></tr>
                                <tr><td><strong>City:</strong></td><td>${item.City}</td></tr>
                                <tr><td><strong>Status:</strong></td><td><span class="badge bg-${item.Status === 'Active' ? 'success' : item.Status === 'Maintenance' ? 'warning' : 'secondary'}">${item.Status}</span></td></tr>
                                <tr><td><strong>Capacity:</strong></td><td>${item.ActualCapacity.toFixed(2)} MT</td></tr>
                                <tr><td><strong>Area:</strong></td><td>${item.TotalArea.toFixed(2)} sq.mt</td></tr>
                                <tr><td><strong>Used:</strong></td><td>${item.Used.toFixed(2)} MT</td></tr>
                                <tr><td><strong>Available:</strong></td><td>${item.Available.toFixed(2)} MT</td></tr>
                                <tr><td><strong>Utilization:</strong></td><td><span class="badge bg-${utilization > 80 ? 'danger' : utilization > 60 ? 'warning' : 'success'}">${utilization}%</span></td></tr>
                                <tr><td><strong>Temperature:</strong></td><td>${item.Temperature.toFixed(1)}°C</td></tr>
                            </table>
                        </div>
                    `);
                }
            });

            // Fit bounds to show all markers
            if (validLocations.length > 0) {
                var group = L.featureGroup(
                    validLocations.map(item => L.marker([item.Latitude, item.Longitude]))
                );
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function exportToExcel() {
            var table = document.getElementById('dataTable');
            var html = table.outerHTML;
            var url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'ColdStorage_Summary_' + new Date().toISOString().slice(0,10) + '.xls';
            link.click();
        }
    </script>
}

<style>
    .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
    }

        .nav-tabs .nav-link.active {
            font-weight: bold;
            background-color: #fff;
        }

        .nav-tabs .nav-link:hover {
            border-color: #dee2e6 #dee2e6 #fff;
        }

    .table th {
        background-color: #343a40;
        color: white;
        font-weight: 600;
    }

    #dataTable {
        font-size: 0.9rem;
    }

    .card {
        border-radius: 8px;
    }

    .card-header {
        font-weight: 600;
    }

    .shadow-sm {
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075) !important;
    }

    .bg-primary {
        background-color: #0d6efd !important;
    }

    .bg-success {
        background-color: #198754 !important;
    }

    .bg-warning {
        background-color: #ffc107 !important;
    }

    .bg-info {
        background-color: #0dcaf0 !important;
    }
</style>